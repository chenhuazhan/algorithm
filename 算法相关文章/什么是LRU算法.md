![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpr16273icLEY6U6gFP0vWheN8Wibfak0AlGVLz7qMpmh0zVdJBANPCHjeX4sx9uV72iaAeMAgzdrN6w/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)





![img](https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpr16273icLEY6U6gFP0vWher6q4OibN7ichBYwJW7dbAYeQicQofVmAOx4xuyYR1GnJXSJA5azgZVo0Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)





![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpr16273icLEY6U6gFP0vWheYfL2LyfDwQQ8cDlj5j5HCB64GBKRmJtqJoAyKpjOUYg1VWD68hL6kw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpr16273icLEY6U6gFP0vWheUgLsS6s1N8EHMRwibbCRP6m6TLVTkmLtwfUp17RJmK92pHZE0S2o4FQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

用户信息当然是存在数据库里。但是由于我们对用户系统的性能要求比较高，显然不能每一次请求都去查询数据库。

所以，小灰在内存中创建了一个哈希表作为缓存，每次查找一个用户的时候先在哈希表中查询，以此提高访问性能。

![img](https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpr16273icLEY6U6gFP0vWhejmS9VDWClDXicr3KEFGqFzmCG7EibicbibtoOsnTBGZaKaFkKIfrflBO5Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)





很快，用户系统上线了，小灰美美地休息了几天。

一个多月之后......

![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpr16273icLEY6U6gFP0vWhelkaZ7fAgKLeL9W9ugj0PtWoKT0XziaFiaib7MGWM73rADiar9Wcf7ibA9vg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpr16273icLEY6U6gFP0vWhesvXEyLZgwdDSWr6GepH07cU8O2T5tdial6JQia0UA7G0mdvibgQ1G5IdQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)



![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpr16273icLEY6U6gFP0vWhe116qpsjN842vIwuia57CfTBJCkp4b2PfAHb4ODXia70TmKaP7Bvnnz8g/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpr16273icLEY6U6gFP0vWhewcLMia6N793Oo6XpBlquEok4I0OLlpGiaSHw4N2zL2icN2eCYB3mLkPAw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpr16273icLEY6U6gFP0vWheyZLCsDeuLZByjNxX2vMFicu7ds0ibiar9GdpyQqEKecwLYeiczlzWvzKww/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpr16273icLEY6U6gFP0vWheu8czBoMqY8UcnTmXibqRIud5L553o2NXYYDZNIAkNQGib6V1ibhmwbKNQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)





![img](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)





———————————————

![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpr16273icLEY6U6gFP0vWhetb7OSEeQBgOfd11POqpjzBW5SGEMMhjJfWfX4p7gAO3BMoOKgYzDAQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uscBud3DbJtQeglCrTic5rXpzDw8JxsjesibmcMYgc3ZSe3UN8uHS92ibg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8ugmUSdUyWT1OjB6eS3kCNtsGYxZ9FVSZpM5kEqokIqNsqav4s4O6bkw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)



![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8u4cX8GBq7Y1Aodvr6IsR5wBPSX5VZcy7h2FonmRiaXsksMNctV7OO4VA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8ubyOEsgzuJXZJwafp6MTEFG7IOW7gCGHXhjrYamMyfBNu916oLIBdAQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8udH8bgNdMRV5QtRuXZQrsyoa54SicOzTgRuiapk7MiaiciaXgrFicCvicU3c2Q/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uWlkHHT0lYeB7JtjYIYJ0t2VzSZ2PHrGZx29lDhEFe3UhoRKfUQIKicg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uz7oYUWXuLdLic9f2HboF8c8VY7xsibJYzicrGNRmia7TSo9vDnJRQPAwNA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)





**什么是哈希链表呢？**

我们都知道，哈希表是由若干个Key-Value所组成。在“逻辑”上，这些Key-Value是无所谓排列顺序的，谁先谁后都一样。

![img](https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uA8sEzFj9LvfDtj8GG0h0d444S9oVGHvw8WSLpceyT1j7kRKT7lpicLw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

在哈希链表当中，这些Key-Value不再是彼此无关的存在，而是被一个链条串了起来。每一个Key-Value都具有它的前驱Key-Value、后继Key-Value，就像双向链表中的节点一样。

![img](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

这样一来，原本无序的哈希表拥有了固定的排列顺序。

![img](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)



![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uLA11FNCgWZtoY5w2nhSbIvDRg9UtZVQTC9KQQGJWSvBbMF1jXPQQxQ/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

让我们以用户信息的需求为例，来演示一下LRU算法的基本思路：

1.假设我们使用哈希链表来缓存用户信息，目前缓存了4个用户，这4个用户是按照时间顺序依次从链表右端插入的。

![img](https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8upzyibzI0QQzmF8CuibJ2WicWAzqgshicC6xJujZ9mL8KVTLFyMyibzXw0Lw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

2.此时，业务方访问用户5，由于哈希链表中没有用户5的数据，我们从数据库中读取出来，插入到缓存当中。这时候，链表中最右端是最新访问到的用户5，最左端是最近最少访问的用户1。

![img](https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uBzpxicKfvWRTnSUjWQic7QnQOgDUicT26gyzCJCN9JnUf0huM3ficfg9TA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

3.接下来，业务方访问用户2，哈希链表中存在用户2的数据，我们怎么做呢？我们把用户2从它的前驱节点和后继节点之间移除，重新插入到链表最右端。这时候，链表中最右端变成了最新访问到的用户2，最左端仍然是最近最少访问的用户1。

![img](https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8usCb0GyZUayGEKODoprVp00hiaI6mo10dl6qZCrxQqg3ibJZgLu4y7ianw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uzCaqO85nU4EibSyVK6dUeCj7lEP8BCHrOwReXLvUMhO4YmiabAs14ypA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

4.接下来，业务方请求修改用户4的信息。同样道理，我们把用户4从原来的位置移动到链表最右侧，并把用户信息的值更新。这时候，链表中最右端是最新访问到的用户4，最左端仍然是最近最少访问的用户1。

![img](https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uUVJcc8cd650ESuWABeticyR1RzpQZ6jz2OA0DUv6s6w8Z97UtWjiaZ2g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8u4pLAE72nWYazKbYNSS3TOlktRRu4xFd2ufIJ9XUHmzMrCVfibYvgc7Q/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

5.后来业务方换口味了，访问用户6，用户6在缓存里没有，需要插入到哈希链表。假设这时候缓存容量已经达到上限，必须先删除最近最少访问的数据，那么位于哈希链表最左端的用户1就会被删除掉，然后再把用户6插入到最右端。

![img](https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uBMOib9ZgBM6v1EibRPh7rkiauj8a0U7WusHSeibDpHyQA6j1DKG9ZFuvzg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uicKXkC0LqnEibuYzZlEJIR4Qy9FJyWCWSDzNUDzQyO1N9LR7te7IXKDg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

以上，就是LRU算法的基本思路。

![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8ubEf7eSBUX1RmceVxexeykd1IVpiaZ8837J6DsP7r4p4E1vJ6ychp4rA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uiaJpA9fCp49eYpeCtHC1XMBJdicJl4t74qBzRibISWaXflpe6dVbtoGLw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

```
private Node head;private Node end;//缓存存储上限private int limit;


private HashMap<String, Node> hashMap;


public LRUCache(int limit) {    this.limit = limit;    hashMap = new HashMap<String, Node>();}


public String get(String key) {    Node node = hashMap.get(key);    if (node == null){        return null;    }    refreshNode(node);    return node.value;}


public void put(String key, String value) {    Node node = hashMap.get(key);    if (node == null) {        //如果key不存在，插入key-value        if (hashMap.size() >= limit) {            String oldKey = removeNode(head);            hashMap.remove(oldKey);        }        node = new Node(key, value);        addNode(node);        hashMap.put(key, node);    }else {        //如果key存在，刷新key-value        node.value = value;        refreshNode(node);    }}


public void remove(String key) {    Node node = hashMap.get(key);    removeNode(node);    hashMap.remove(key);}


/** * 刷新被访问的节点位置 * @param  node 被访问的节点 */private void refreshNode(Node node) {    //如果访问的是尾节点，无需移动节点    if (node == end) {        return;    }    //移除节点    removeNode(node);    //重新插入节点    addNode(node);}


/** * 删除节点 * @param  node 要删除的节点 */
 
private String removeNode(Node node) {    if (node == end) {        //移除尾节点        end = end.pre;    }else if(node == head){        //移除头节点        head = head.next;    } else {        //移除中间节点        node.pre.next = node.next;        node.next.pre = node.pre;    }    return node.key;}


/** * 尾部插入节点 * @param  node 要插入的节点 */private void addNode(Node node) {    if(end != null) {        end.next = node;        node.pre = end;        node.next = null;    }    end = node;    if(head == null){        head = node;    }}


class Node {    Node(String key, String value){        this.key = key;        this.value = value;    }    public Node pre;    public Node next;    public String key;    public String value;}


public static void main(String[] args) {    LRUCache lruCache = new LRUCache(5);    lruCache.put("001", "用户1信息");    lruCache.put("002", "用户1信息");    lruCache.put("003", "用户1信息");    lruCache.put("004", "用户1信息");    lruCache.put("005", "用户1信息");    lruCache.get("002");    lruCache.put("004", "用户2信息更新");    lruCache.put("006", "用户6信息");    System.out.println(lruCache.get("001"));    System.out.println(lruCache.get("006"));}
```

需要注意的是，这段不是线程安全的，要想做到线程安全，需要加上synchronized修饰符。

![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uhSFMGALTbzAGicDEDswibhw9S7fOdwkz1djJEPWIMM3ANfoWRRBbnpWw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uibsiamZN8dF3ZxNlm2iaEqsAoynGuxTvjYV12eBtqLxicmO7muctOAUVLA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8uw5dHNibs4QnWpkicgTRpkbEkUgEK0smTYL8BzXuOXF9K5nASuk1lP2Jw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![img](https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpzr3eMdzxP8iawGvibB1dc8u4icgLrE3fvq5IhsFYSnvaXxN0qekdiaoYlia7Fqnjz57oFLMkwngKrE0A/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

[原文](http://mp.weixin.qq.com/s?__biz=MjM5MjAwODM4MA==&mid=2650719941&idx=2&sn=566c93fc8b2793024beab2591d190d4f&chksm=bea6b71689d13e00fe382bad6b9ed804940930af2b04482ac95f9e92b95fec5ecfa875229c87&scene=0&xtrack=1#rd)

